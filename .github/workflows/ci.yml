name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  secrets-presence:
    name: Secrets Presence (release branches)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (github.ref_name == 'main' || startsWith(github.ref_name, 'release/'))
    steps:
      - name: Validate required secret keys are configured
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YELP_API_KEY: ${{ secrets.YELP_API_KEY }}
          FOURSQUARE_API_KEY: ${{ secrets.FOURSQUARE_API_KEY }}
        run: |
          set -euo pipefail
          missing=0
          for key in \
            FIREBASE_API_KEY \
            FIREBASE_AUTH_DOMAIN \
            FIREBASE_PROJECT_ID \
            FIREBASE_STORAGE_BUCKET \
            FIREBASE_MESSAGING_SENDER_ID \
            FIREBASE_APP_ID \
            GOOGLE_MAPS_API_KEY \
            OPENAI_API_KEY \
            YELP_API_KEY \
            FOURSQUARE_API_KEY
          do
            value="${!key:-}"
            if [ -z "$value" ]; then
              echo "Missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
          echo "All required secrets are present."

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            functions/package-lock.json
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Run ESLint
        run: npm run lint

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            functions/package-lock.json
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Install Cloud Functions dependencies
        run: npm ci --prefix functions --legacy-peer-deps
      - name: Run TypeScript type check
        run: npm run typecheck

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            functions/package-lock.json
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Install Cloud Functions dependencies
        run: npm ci --prefix functions --legacy-peer-deps
      - name: Run tests
        run: npm test -- --runInBand

  functions-typecheck:
    name: Functions Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json
      - name: Install Cloud Functions dependencies
        run: npm ci --prefix functions --legacy-peer-deps
      - name: Run Functions type check
        run: npm --prefix functions run build

  functions-test:
    name: Functions Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json
      - name: Install Cloud Functions dependencies
        run: npm ci --prefix functions --legacy-peer-deps
      - name: Run Functions tests
        run: npm --prefix functions test

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Run npm audit
        run: npm audit --audit-level=high || true
      - name: Check for critical vulnerabilities
        run: |
          if npm audit --audit-level=critical 2>&1 | grep -q "found.*critical"; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
